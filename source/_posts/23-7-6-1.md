---
title: ä½¿ç”¨umi useModel ç®€æ˜“æ•°æ®æµè¿›è¡Œå•å…ƒæµ‹è¯•çš„ç®€å•æ–¹æ³•
date: 2023/7/6
author: A
categories:
- æŠ€æœ¯
tags:
- åŸåˆ›
- react
- umi
- å•å…ƒæµ‹è¯•
---

## ä¸èƒ½ç›´æ¥æµ‹è¯•çš„åŸå› 
![Cannot read properties of undefined (reading '@@initialState') ](http://120.26.15.146/s/img/23-7-6-1.png)
æŠ¥é”™  Cannot read properties of undefined (reading '@@initialState')     
çœ‹æºç 
![æºç ](https://img-blog.csdnimg.cn/dfa78eabf7d5410682179c25ad5779e8.png#pic_center)
useModelåœ¨å†…éƒ¨æ˜¯ä½¿ç”¨äº†useContext()ï¼Œæµ‹è¯•ç»„ä»¶æ—¶åœ¨ä¸Šå±‚å¹¶æ²¡æœ‰å¯¹åº”çš„Providerï¼Œæ‰€ä»¥è¯»å–ä¸åˆ°UniContextï¼Œæ›´æ‹¿ä¸åˆ°@@initialState
## å®ç°æ–¹æ¡ˆ
åœ¨æµ‹è¯•è¯¥ç»„ä»¶æ—¶å®šä¹‰åº”è¯¥çˆ¶ç»„ä»¶UniContext.Providerï¼Œåœ¨è¿™é‡Œæå‰æŒ‡å®šå¥½contextã€‚
è¿™é‡Œç®€å•å°è£…ä¸€ä¸‹ï¼Œå› ä¸ºæ˜¯ç®€å•å®ç°æ‰€ä»¥æ²¡å†™æ›´å¤šçš„åŠŸèƒ½
```javascript
import { UmiContext } from '@/.umi/plugin-model/helpers/constant';
import React from 'react';

interface ITestModelProps {
  data: Record<string, any>;
}

const TestModel: React.FunctionComponent<ITestModelProps> = (props) => {
  const callbackSet = new Set([() => {}]);
  const callbacks: Record<string, Set<() => void>> = {};
  Object.keys(props.data).forEach((item) => {
    callbacks[item] = callbackSet;
  });
  const update = (namespace: string) => {
    callbacks[namespace].forEach((callback: (val: any) => void) => {
      callback(props.data);
    });
  };
  return (
    <UmiContext.Provider
      value={{
        data: props.data,
        callbacks,
        update,
      }}
    >
      {props.children}
    </UmiContext.Provider>
  );
};

export default TestModel;

```

## ä½¿ç”¨æ–¹å¼

```javascript
test('test Home page', async () => {
	//...çœç•¥mockè·å–æ•°æ®
	const ins = render(
      <TestModel
        data={{
          '@@initialState': { initialState: { currentUserInfo, settings: defaultSettings } },
        }}
      >
        <Home />
      </TestModel>,
    );
	//...çœç•¥æµ‹è¯•å†…å®¹
}
```
### ç›¸å…³GitHub Issues é“¾æ¥
- [jestæµ‹è¯•ä¸ç®€æ˜“æ•°æ®æµä»¥åŠå…¨å±€åˆå§‹æ•°æ®ä¸å…¼å®¹ğŸ›[BUG] #9206][1]
- [ğŸ‘‘ [éœ€æ±‚] èƒ½å¦æä¾›ä¸€ä¸ªå•å…ƒæµ‹è¯•çš„ç¤ºä¾‹ï¼Œç¤ºæ„å¦‚ä½• mock å›½é™…åŒ–å’Œ useModel ä¹‹ç±»çš„ï¼Ÿ #9211][2]

 [1]: https://github.com/ant-design/ant-design-pro/issues/9206
 [2]: https://github.com/ant-design/ant-design-pro/issues/9211